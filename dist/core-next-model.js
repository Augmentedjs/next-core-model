!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash.clone"),require("next-core-object"),require("next-core-utilities"),require("next-core-validation"),require("lodash.result"),require("lodash.isempty"),require("lodash.has"),require("lodash.defaults"),require("lodash.iteratee"),require("lodash.defer"),require("lodash.escape")):"function"==typeof define&&define.amd?define("core-next-model",["lodash.clone","next-core-object","next-core-utilities","next-core-validation","lodash.result","lodash.isempty","lodash.has","lodash.defaults","lodash.iteratee","lodash.defer","lodash.escape"],e):"object"==typeof exports?exports["core-next-model"]=e(require("lodash.clone"),require("next-core-object"),require("next-core-utilities"),require("next-core-validation"),require("lodash.result"),require("lodash.isempty"),require("lodash.has"),require("lodash.defaults"),require("lodash.iteratee"),require("lodash.defer"),require("lodash.escape")):t["core-next-model"]=e(t["lodash.clone"],t["next-core-object"],t["next-core-utilities"],t["next-core-validation"],t["lodash.result"],t["lodash.isempty"],t["lodash.has"],t["lodash.defaults"],t["lodash.iteratee"],t["lodash.defer"],t["lodash.escape"])}(this,(function(t,e,s,i,r,n,l,o,h,a,d){return function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="/dist/",s(s.s=6)}([function(e,s){e.exports=t},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s(2),r=s(3),n=s(4);const l=s(0),o=s(7),h=s(8),a=s(9),d=s(0),u=s(10),c=s(11),g=s(12),f=s(13),p=(t,e)=>{if(t){const s=e.error;e.error=i=>{s&&s.call(e.context,t,i,e),t.trigger("error",t,i,e)}}};e.default=class extends i.AugmentedObject{constructor(t,e,...s){let i;super(e),this.id=0,this.idAttribute="id",this.cidPrefix="c",this.defaults={},this.validationError=null,this.urlRoot="",this._pending=!1,this._changing=!1,this._previousAttributes=null,this._attributes=t||{},e||(e={}),this.schema=null,this.validationMessages={valid:!0},e&&e.schema&&(this.schema=e.schema),this.preinitialize(s),this.cid=(0,r.uniqueId)(this.cidPrefix),e&&e.collection&&(this.collection=e.collection),e&&e.parse&&(i=this.parse(i,e)||{}),this.defaults=o(this,"defaults"),i=u((0,r.extend)({},this.defaults,i),this.defaults),this.set(i,e),this.changed={},this.initialize(s)}preinitialize(...t){}initialize(...t){}get(t){return this._attributes[t]}set(t,e,s){if(null===t)return this;let i;if("object"==typeof t?(i=t,s=e):(i={})[t]=e,s||(s={}),!this._validate(i,s))return console.warn("Model did not validate"),!1;const r=s.unset,n=s.silent,o=[];let h=this._changing;this._changing=!0,h||(this._previousAttributes=l(this._attributes),this.changed={});let a=this._attributes,u=this.changed;const c=this._previousAttributes;let g;for(g in i)e=i[g],"string"==typeof a[g]&&"string"==typeof e&&a[g]!==e?o.push(g):d(a[g],e)||o.push(g),"string"==typeof c[g]&&"string"==typeof e&&c[g]!==e?u[g]=e:d(c[g],e)?delete u[g]:u[g]=e,r?delete a[g]:a[g]=e;if(this.idAttribute in i&&(this.id=this.get(this.idAttribute)),!n){o.length&&(this._pending=s);let t=0;for(t=0;t<o.length;t++)this.trigger("change:"+o[t],this,a[o[t]],s)}if(h)return this;if(!n)for(;this._pending;)s=this._pending,this._pending=!1,this.trigger("change",this,s);return this._pending=!1,this._changing=!1,this}escape(t){return f(this.get(attr))}has(t){return null!==this.get(attr)}matches(t){return!!c(t,this)(this._attributes)}unset(t,e){return this.set(t,void 0,(0,r.extend)({},e,{unset:!0}))}clear(t){let e={};for(let t in this._attributes)e[t]=void 0;return this.set(e,(0,r.extend)({},t,{unset:!0}))}toJSON(){return l(this._attributes)}fetch(t){t=(0,r.extend)({parse:!0},t);let e=this,s=t.success;return t.success=i=>{let r=t.parse?e.parse(i,t):i;if(!e.set(r,t))return!1;s&&s.call(t.context,e,i,t),e.trigger("sync",e,i,t)},p(this,t),this.sync("read",this,t)}save(t,e,s){let i;null==t||"object"==typeof t?(i=t,s=e):(i={})[t]=e;let n=(s=(0,r.extend)({validate:!0,parse:!0},s)).wait;if(i&&!n){if(!this.set(i,s))return!1}else if(!this._validate(i,s))return!1;let l=this,o=s.success,h=this._attributes;s.success=t=>{l.attributes=h;let e=s.parse?l.parse(t,s):t;if(n&&(e=(0,r.extend)({},i,e)),e&&!l.set(e,s))return!1;o&&o.call(s.context,l,t,s),l.trigger("sync",l,t,s)},p(this,s),i&&n&&(this._attributes=(0,r.extend)({},h,i));let a=this.isNew()?"create":s.patch?"patch":"update";"patch"!==a||s.attrs||(s.attrs=i);let d=this.sync(a,this,s);return this._attributes=h,d}destroy(t){t=t?l(t):{};let e=this,s=t.success,i=t.wait,r=()=>{e.stopListening(),e.trigger("destroy",e,e.collection,t)};t.success=n=>{i&&r(),s&&s.call(t.context,e,n,t),e.isNew()||e.trigger("sync",e,n,t)};let n=!1;return this.isNew()?g(t.success):(p(this,t),n=this.sync("delete",this,t)),i||r(),n}url(){let t=o(this,"urlRoot")||o(this.collection,"url")||urlError();if(this.isNew())return t;let e=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(e)}keys(){return Object.keys(this._attributes)}values(){return Object.values(this._attributes)}parse(t,e){return t}clone(){return new this.constructor(this._attributes)}isNew(){return!this.has(this.idAttribute)}hasChanged(t){return null==t?!h(this.changed):a(this.changed,t)}changedAttributes(t){if(!t)return!!this.hasChanged()&&l(this.changed);let e,s=this._changing?this._previousAttributes:this._attributes,i={};for(let r in t){let n=t[r];d(s[r],n)||(i[r]=n,e=!0)}return!!e&&i}previous(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null}previousAttributes(){return l(this._previousAttributes)}supportsValidation(){return null!==this.schema}isValid(t){const e=this._validate({},(0,r.extend)({},t,{validate:!0}));if(e){this.validate();return this.validationMessages.valid}return e}validate(){this._validationFramework||(this._validationFramework=new n.ValidationFramework);const t=this._validationFramework;return this.supportsValidation()&&t.supportsValidation()?this.validationMessages=t.validate(this.toJSON(),this.schema):this.validationMessages.valid=!0,this.validationMessages}getValidationMessages(){const t=[];if(this.validationMessages&&this.validationMessages.errors){const s=this.validationMessages.errors.length;var e=0;for(e=0;e<s;e++)t.push(this.validationMessages.errors[e].message+" from "+this.validationMessages.errors[e].dataPath)}return t}sync(t,e,s){}reset(t){this.clear(),t&&this.set(t)}isEmpty(){return!this._attributes||0===Object.keys(this._attributes).length}toString(){return JSON.stringify(this.toJSON())}fetch(t){this.sync("read",this,t)}save(t){this.sync("create",this,t)}update(t){this.sync("update",this,t)}destroy(t){this.sync("delete",this,t)}_validate(t,e){if(e&&(!e.validate||!this.validate))return!0;const s=this.validate();return!!s.valid||(this.trigger("invalid",this,s,(0,r.extend)(e,{validationError:s})),!1)}}},function(t,s){t.exports=e},function(t,e){t.exports=s},function(t,e){t.exports=i},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=1,r=2;e.default=class{constructor(t,e){this._collection=t,this._kind=e,this._index=0}next(){if(this._collection){if(this._index<this._collection.length){const t=this._collection.at(this._index);let e;if(this._index++,this._kind===i)e=t;else{const s=this._collection.modelId(t.attributes);e=this._kind===r?s:[s,t]}return{value:e,done:!1}}this._collection=void 0}return{value:void 0,done:!0}}}},function(t,e,s){"use strict";var i=l(s(1)),r=l(s(14)),n=l(s(5));function l(t){return t&&t.__esModule?t:{default:t}}t.exports.AbstractModel=i.default,t.exports.AbstractCollection=r.default,t.exports.CollectionIterator=n.default},function(t,e){t.exports=r},function(t,e){t.exports=n},function(t,e){t.exports=l},function(t,e){t.exports=o},function(t,e){t.exports=h},function(t,e){t.exports=a},function(t,e){t.exports=d},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s(2),r=s(3),n=h(s(1)),l=s(4),o=h(s(5));function h(t){return t&&t.__esModule?t:{default:t}}const a=(t,e)=>t.filter(t=>Object.keys(e).every(s=>t._attributes[s]===e[s])),d=s(0),u={add:!0,remove:!0,merge:!0},c={add:!0,remove:!1};e.default=class extends i.AugmentedObject{constructor(t,e){super(e),this.length=0,this.models=[],this._byId={},this.schema=null,this.validationMessages={valid:!0},e||(e={}),this.preinitialize(t,e),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize(t,e),t&&this.add(t,(0,r.extend)({silent:!0},e)),this.model||(this.model=new n.default)}preinitialize(t,e){}initialize(t,e){}toJSON(){let t=0;const e=[],s=this.models.length;for(t=0;t<s;t++)e[t]=this.models[t].toJSON();return e}add(t,e){return this.set(t,(0,r.extend)({merge:!1},e,c))}remove(t,e){e=(0,r.extend)({},e);const s=Array.isArray(t);t=s?[t]:t.slice();let i=this._removeModels(t,e);return!e.silent&&i.length&&(e.changes={added:[],merged:[],removed:i},this.trigger("update",this,e)),s?i[0]:i}set(t,e){if(null===t)return;(e=(0,r.extend)({},u,e)).parse&&!this._isModel(t)&&(t=this.parse(t,e)||[]);let s=!Array.isArray(t);t=s?[t]:t.slice();let i=e.at;null!=i&&(i=+i),i>this.length&&(i=this.length),i<0&&(i+=this.length+1);let n,l,o=[],h=[],a=[],d=[],c={},g=e.add,f=e.merge,p=e.remove,v=!1,m=this.comparator&&null==i&&!1!==e.sort,_=(0,r.isString)(this.comparator)?this.comparator:null;const b=t.length;for(l=0;l<b;l++){n=t[l];let s=this.get(n);if(s){if(f&&n!==s){let t=this._isModel(n)?n._attributes:n;e.parse&&(t=s.parse(t,e)),s.set(t,e),a.push(s),m&&!v&&(v=s.hasChanged(_))}c[s.cid]||(c[s.cid]=!0,o.push(s)),t[l]=s}else g&&(n=t[l]=this._prepareModel(n,e))&&(h.push(n),this._addReference(n,e),c[n.cid]=!0,o.push(n))}if(p){for(l=0;l<this.length;l++)c[(n=this.models[l]).cid]||d.push(n);d.length&&this._removeModels(d,e)}let y=!1,x=!m&&g&&p;if(o.length&&x?(y=this.length!==o.length||(0,r.some)(this.models,(t,e)=>t!==o[e]),this.models.length=0,(0,r.splice)(this.models,o,0),this.length=this.models.length):h.length&&(m&&(v=!0),(0,r.splice)(this.models,h,null==i?this.length:i),this.length=this.models.length),v&&this.sort({silent:!0}),!e.silent){for(l=0;l<h.length;l++)null!=i&&(e.index=i+l),(n=h[l]).trigger("add",n,this,e);(v||y)&&this.trigger("sort",this,e),(h.length||d.length||a.length)&&(e.changes={added:h,removed:d,merged:a},this.trigger("update",this,e))}return s?t[0]:t}reset(t,e){e=e?d(e):{};for(let t=0;t<this.models.length;t++)this._removeReference(this.models[t],e);return e.previousModels=this.models,this._reset(),t=this.add(t,(0,r.extend)({silent:!0},e)),e.silent||this.trigger("reset",this,e),t}push(t,e){return this.add(t,(0,r.extend)({at:this.length},e))}pop(t){const e=this.at(this.length-1);return this.remove(e,t)}unshift(t,e){return this.add(t,(0,r.extend)({at:0},e))}shift(t){const e=this.at(0);return this.remove(e,t)}slice(...t){return this.models.slice(t)}get(t){if(null!=t)return this._byId[t]||this._byId[this.modelId(this._isModel(t)?t._attributes:t)]||t.cid&&this._byId[t.cid]}has(t){return null!==this.get(t)}at(t){return t<0&&(t+=this.length),this.models[t]}find(t){const e=a(this.models,t);return e&&e.length>0?e[0]:null}filter(t){return a(this.models,t)}where(t,e){return e?this.find(t):this.filter(t)}findWhere(t){return this.where(t,!0)}sort(t){let e=this.comparator;if(!e)throw new Error("Cannot sort a set without a comparator");t||(t={});let s=e.length;return(0,r.isFunction)(e)&&(e=e.bind(this)),1===s||(0,r.isString)(e)?this.models=this.sortBy(e):this.models.sort(e),t.silent||this.trigger("sort",this,t),this}pluck(t){let e=0;const s=[],i=this.models.length;for(e=0;e<i;e++)s[e]=this.models[e].toJSON()[t];return s}fetch(t){}create(t,e){let s=(e=e?d(e):{}).wait;if(!(t=this._prepareModel(t,e)))return!1;s||this.add(t,e);let i=this,r=e.success;return e.success=(t,e,n)=>{s&&i.add(t,n),r&&r.call(n.context,t,e,n)},t.save(null,e),t}parse(t,e){return t}clone(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})}modelId(t){return t&&this.model&&this.model.idAttribute?t[this.model.idAttribute||"id"]:"id"}values(){return new o.default(this,ITERATOR_VALUES)}keys(){return new o.default(this,ITERATOR_KEYS)}entries(){return new o.default(this,ITERATOR_KEYSVALUES)}supportsValidation(){return!!(this.schema&&null!==this.schema&&this.schema!=={})}isValid(){return!this.validationMessages||this.validationMessages.valid}getValidationMessages(){return this.validationMessages&&this.validationMessages.messages?this.validationMessages.messages:[]}validate(){if(this.supportsValidation()){let t=[];this.validationMessages.messages=t,this.validationMessages.valid=!0;const e=this.toJSON(),s=e&&Array.isArray(e)?e.length:0;let i=0;this._validationFramework||(this._validationFramework=new l.ValidationFramework);const r=this._validationFramework;for(i=0;i<s;i++)t[i]=r.validate(e[i],this.schema),t[i].valid||(this.validationMessages.valid=!1)}else this.validationMessages.valid=!0;return this.validationMessages}sync(t,e,s){}save(t){this.sync("create",this,t)}update(t){this.sync("update",this,t)}remove(t){this.sync("delete",this,t)}sortByKey(t){if(t){const e=this.toJSON();if(e){const s=(0,r.sortObjects)(e,t);this.reset(s)}}}isEmpty(){return 0===this.length}size(){return this.length}toString(){let t={};try{t=JSON.stringify(this.toJSON())}catch(t){console.error(t)}return t}_reset(){this.length=0,this.models=[],this._byId={}}_prepareModel(t,e){if(this._isModel(t))return t.collection||(t.collection=this),t;(e=e?d(e):{}).collection=this;const s=new n.default(t,e);return s.validationError?(this.trigger("invalid",this,s.validationError,e),!1):s}_removeModels(t,e){let s=[];for(let i=0;i<t.length;i++){let r=this.get(t[i]);if(!r)continue;let n=this.at(r);this.models.splice(n,1),this.length--,delete this._byId[r.cid];let l=this.modelId(r._attributes);null!=l&&delete this._byId[l],e.silent||(e.index=n,r.trigger("remove",r,this,e)),s.push(r),this._removeReference(r,e)}return s}_isModel(t){return t instanceof n.default}_addReference(t,e){this._byId[t.cid]=t;let s=this.modelId(t._attributes);null!=s&&(this._byId[s]=t),t.on("all",this._onModelEvent,this)}_removeReference(t,e){delete this._byId[t.cid];let s=this.modelId(t._attributes);null!=s&&delete this._byId[s],this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)}_onModelEvent(t,e,s,i){if(e){if(("add"===t||"remove"===t)&&s!==this)return;if("destroy"===t&&this.remove(e,i),"change"===t){let t=this.modelId(e.previousAttributes()),s=this.modelId(e._attributes);t!==s&&(null!=t&&delete this._byId[t],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}}}])}));
//# sourceMappingURL=core-next-model.js.map